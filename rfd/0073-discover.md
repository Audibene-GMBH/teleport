---
authors: Roman Tkachenko (roman@goteleport.com)
state: draft
---

# RFD 73 - Teleport Discover

## Required approvers

@klizhentas && @xinding33

## What

Proposes the `teleport discover` command that simplifies the UX for the
first-time users who are connecting their cloud resources to Teleport.

## Related RFDs

- [RFD 38: AWS databases auto-discovery](./0038-database-access-aws-discovery.md)
- [RFD 57: AWS EC2 nodes auto-discovery](https://github.com/gravitational/teleport/pull/12410)

## Why

The proposal is aimed at providing an easy way for Teleport administrators to
connect their cloud-hosted resources (EC2 instances, RDS databases, EKS clusters
an so on) to a Teleport cluster.

Over the past few releases Teleport has been adding automatic discovery
capabilities allowing it to find and register AWS databases, EC2 instances
and (WIP as of this writing) EKS clusters. Despite providing an improved UX
compared to registering the resources manually, connecting resources to cluster
and setting up auto-discovery remains cumbersome with multiple different
`teleport configure` commands and does not provide good visibility into the
discovered resources.

The `teleport discover` approach aims to take advantage of the existing auto
discovery mechanisms Teleport has and provide a unified approach for users to
enroll their cloud resources.

## Scope

- Works with both self-hosted edition and Teleport Cloud.
- Focuses on discovering resources in AWS, other clouds to follow.
- Covers currently supported cloud resources: EC2 instances and RDS databases.
- The phase 1 of the implementation will only support EC2 instances and SSH.

## Prerequisites

In order to use `teleport discover` the user will need:

- Running Auth and Proxy, or a Cloud account.
- An AWS EC2 instance to run `teleport discover` command from. The node must have
  IAM identity allowing it to perform discovery operations in AWS account.

## Command

The goal for `teleport discover` is to eventually support multiple cloud
providers. Given that different providers often have different concepts and
different names for similar things, it may be hard to unify them all under a
single `teleport discover` command without making UX confusing, having
overlapping or prefixed flags, etc.

Hence, the proposal is to have a family of subcommands for different cloud
providers:

```
$ teleport discover aws ...
$ teleport discover gcp ...
```

This RFD will focus on `teleport discover aws`.

## Usage

The default mode of operation of the `teleport discover` command is to support
the UI wizard users will use to join their resources to the cluster.

Users will go through the following flow in the wizard-style dialog in the
Teleport Web UI:

- Select which environment to look for resources in. E.g. self-hosted (which
  will use existing automatic join scipts), AWS or other cloud (which will use
  the discover flow), as well as regions.
- Select types of resources to import. For AWS users will be offered all types
  we currently support auto-discovery for: EC2, RDS/Aurora, Redshift, Elasticache,
  MemoryDB. The dialog may optionally allow to specify tags to filter the
  resources by.
- Based on the selected resources, display appropriate `teleport discover aws`
  command to run and the IAM policy required for the command to successfully
  discover and join resources.

Users will launch the `teleport discover aws` command on an AWS instance that
has IAM permissions required to discover and connect resoures. We'll detail
those permissions later.

The command will:

1. Join the Teleport cluster as a "discover" agent using the same cluster join
   mechanism as any other agent. Join token will be generated by the server
   and included in the CLI command displayed to a user.
2. Using the node's IAM credentials, search the cloud account for the requested
   resources according to the command's filters.
3. Once discovered, the agent will start heartbeating the discovered resources
   to the cluster with TTL using the same heartbeat mechanism as any other
   type of resource. Heartbeating resources to the cluster will allow the UI
   to pick them up and show to the user.
4. Wait for the user to inspect discovered resources in the UI wizard and select
   those they would like to connect.
5. Once confirmed, proceed with importing resources to the cluster. Details
   below on how this works for each particular resource type.
6. After importing all resources, `teleport discover` will generate Teleport
   config file `/etc/teleport.yaml`, start the Teleport service on the node
   and exit.

## Details

### 1. Join

Running as an agent and joining the Teleport cluster allows `teleport discover`
to share progress with the UI wizard served by the Proxy. The command will also
have a CLI-only mode which will be detailed later.

Discover agent will use the same cluster join mechanism as any other type of
agent e.g. SSH node, application or database service. A new auth token type
`discover` will be introduced for the discover agent. Users will be able to
create it same way as any other token type:

```
$ tctl tokens add --type=discover
```

The `teleport discover` command shown to a user by the UI wizard will include
a pre-generated short-lived auth token:

```
$ teleport discover aws --proxy=proxy.example.com:443 --token=abc123
```

When running `teleport discover` manually in a CLI mode, users will generate
dynamic auth token using `tctl tokens add` command.

### 2. Search

The `teleport discover` command will use default credential provider chain to
determine the cloud account credentials. For AWS this includes IAM role, then
environment variables, then shared credentials file - all of which is handled
by the SDK automatically.

`teleport discover` will use respective `Describe*` AWS SDK methods to scan
the cloud account for the requested resources in the requested regions.

```
$ teleport discover aws \
    --regions=us-east-1,us-west-2 \
    --types=ec2,rds,redshift \
    --labels=teleport:true
```

If not specified explicitly, the discover agent will default to searching for
all supported resources matching any labels in the US regions.

### 3. Heartbeat

`teleport discover` will periodically heartbeat discovered resources to the
cluster's Auth server with some TTL.

The discovery heartbeat will use similar mechanism as used by other agents and
each discovered resource will be converted to a Teleport resource. For example,
each EC2 instance will be heartbeat as a `Server` resource, each RDS database
as a `Database` resource, etc. Each resource will include cloud metadata needed
to later identify the cloud resource it corresponds to.

To prevent mixing up the resources that are already part of the cluster with
the resources from the discover flow, the discover heartbeat will keep them
under a different path in the Auth backend.

Each `teleport discover` run will have a unique ID which will allow to retrieve
resources discovered during this particular run. This will allow the UI (or the
CLI in the CLI-only mode) to display the discovered resources to the user.

The ID will be auto-generated as a UUIDv4 or can be optionally specified on the
command line:

```
$ teleport discover aws --discover-id=abc123
```

Every discovered resource will be associated with this ID by being stored under
a particular path in the backend during the heartbeat, e.g.

```
/discover/abc123/discovered/server/node-1
/discover/abd123/discovered/db/mysql
```

A set of backend APIs will need to be implemented to enable this flow, as well
as a web API handler for the UI to retrieve discovered resources:

```
GET /webapi/sites/:site/discover/:id/servers
GET /webapi/sites/:site/discover/:id/databases
...
// returns a list of JSON-dumped resources
```

### 4. Confirmation

After launching the discover and heartbeat service, the discover command will
block waiting for the user to inspect the resources in the UI and select those
they want to connect.

All resources selected by the user will be saved under a different path in the
backend for the same discover run:

```
/discover/abc123/connect/server/node-1
/discover/abd123/connect/db/mysql
```

The web UI will call a new API handler to post resources selected by the user:

```
POST /webapi/sites/:site/discover/:id/servers
POST /webapi/sites/:site/discover/:id/databases
...
```

The `teleport discover` command will watch the `/discover/<id>/connect` key and
bring the resources that appear there into the cluster.

### 5. Import

For EC2 nodes `teleport discover` will:

- Use SSM to install a Teleport SSH agent on each EC2 instance using the same
  approach as described in RFD 57.

For RDS and other AWS databases `teleport discover` will:

- Register discovered databases in Teleport using dynamic resource registration.

Doing so will require appropriate IAM permissions to run SSM commands (for SSH)
and setup IAM policies (for RDS).

### 6. Shutdown

After importing all resources, `teleport discover` will print out a summary of
all connected resources, generate the `/etc/teleport.yaml` configuration file,
start Teleport service on the node and then exit.

Generated configuration file will enable services matching the discovery
configuration, for example:

```yaml
ssh_service:
  enabled: "yes"
  aws:
  - types: ["ec2"]
    regions: ["us-east-1"]
    tags:
      "*": "*"
db_service:
  enabled: "yes"
  aws:
  - types: ["rds", "redshift", ...]
    regions: ["us-east-1"]
    tags:
      "*": "*"
```

## CLI mode

With the `--cli-mode` flag, the command will allow the user to view discovered
resources and connect them using CLI only flow:

```sh
$ teleport discover aws --proxy=proxy.example.com --token=xxx --cli-mode
üîë Found AWS credentials, account 1234567890, user alice
üîç Looking for EC2, RDS, Redshift and EKS resources in us-east-1, us-east-2 regions
üîç Hint: use --types and --regions flags to narrow down the search
üîç Found the following matching resources:

Type          Name/ID            Region      Tags
---------------------------------------------------------------------
AWS EC2       node-1/i-12345     us-east-1   env:prod,os:ubuntu
AWS EC2       node-2/i-67890     us-east-1   env:prod,os:centos
AWS EC2       node-1/i-54321     us-west-2   env:test
AWS RDS       mysql-prod         us-east-1   env:prod,engine:mysql
AWS RDS       postgres           us-east-1   env:test,engine:postgres
AWS Redshift  redshift-1         us-west-2   team:warehouse

‚ùì Would you like to connect all discovered resources? yes/no
üöú Installing Teleport SSH service on [node-1/i-12345] in us-east-1... ‚úÖ
üöú Installing Teleport SSH service on [node-2/i-67890] in us-east-1... ‚úÖ
üöú Installing Teleport SSH service on [node-1/i-54321] in us-west-2... ‚úÖ
üõ¢ Registering RDS MySQL database [mysql-prod] from us-east-1... ‚úÖ
üõ¢ Registering Aurora PostgreSQL database [postgres] from us-east-1... ‚úÖ
üõ¢ Registering Redshift database [redshift-1] from us-west-2... ‚úÖ
üî® Updating IAM permissions for auto-discovery for this instance's role... ‚úÖ
üî® Generated Teleport configuration file /etc/teleport.yaml ‚úÖ
üî® Starting Teleport service... ‚úÖ
üéâ Done!
```

Optional command flags:

`--regions`          | Cloud regions to search in. Defaults to US regions.
`--types`            | Resource types to consider. Defaults to `ec2`, `rds`, `redshift`, `eks` (when implemented).
`--labels`           | Labels (tags in AWS) resources should match. Defaults to `*: *`.
`--ec2`              | Selectors for EC2 nodes e.g. `us-east-1:env:prod` or `us-west-2:*:*`.
`--rds`              | Selectors for RDS databases.
`--redshift`         | Selectors for Redshift clusters.
`--elasticache`      | Selectors for Elasticache clusters.
`--memorydb`         | Selectors for MemoryDB clusters.
`--eks`              | Selectors for EKS clusters (when implemented).
`--disable-discovery`| Disables auto-discovery on the agent.
`--config-out`       | If provided, write config file to specified path instead of starting Teleport.

## Security

The instance where the user runs `teleport discover` will need to have the
following AWS IAM permissions:

* List/describe permissions for EC2, RDS and other resources user wants to connect.
* SSM permissions to be able to run commands on EC2 instances to install agents.
* IAM permissions to be able to setup IAM permissions for auto-discovery.

The discover command will never ask the user to enter any credentials and instead
rely on standard cloud provider credential chain.

### IAM

Auto-discovery requires specific IAM permissions on the node that runs an agent
performing discovery.

`teleport discover` will use the same mechanism for attaching appropriate IAM
roles used by `teleport db configure` and `teleport ssh configure` commands.
